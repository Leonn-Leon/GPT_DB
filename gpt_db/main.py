import os
import json
import datetime
import yaml
from typing import List, Annotated, Union, Dict
from typing_extensions import TypedDict

# --- Langchain & Langgraph Imports ---
from langgraph.graph import StateGraph, START, END
from langgraph.checkpoint.sqlite import SqliteSaver
from langgraph.graph.message import add_messages

from langchain_core.messages import AIMessage, HumanMessage, SystemMessage, BaseMessage
from langchain_gigachat.chat_models import GigaChat

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
BASE_HISTORY_FILE = "history_base.json"
CHECKPOINT_DB = "checkpoints.sqlite"
CONFIG_FILE = "gpt_db/data/confs/config.yaml"
STRUCTURE_FILE = 'gpt_db/data/confs/otgruzki_structure.txt'
DIVISIONS_FILE = 'gpt_db/data/confs/divisions.txt'

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –¥–∞–Ω–Ω—ã—Ö ---

def _load_config_and_data():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é GigaChat, —Å—Ö–µ–º—É –ë–î –∏ –¥–∏–≤–∏–∑–∏–æ–Ω—ã."""
    try:
        with open(CONFIG_FILE, "r", encoding="utf-8") as f:
            config = yaml.safe_load(f)
        gigachat_credentials = config["GIGACHAT_CREDENTIALS"]
    except FileNotFoundError:
        print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ '{CONFIG_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        exit(1)
    except KeyError:
        print(f"–û—à–∏–±–∫–∞: –ö–ª—é—á 'GIGACHAT_CREDENTIALS' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ '{CONFIG_FILE}'.")
        exit(1)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ '{CONFIG_FILE}': {e}")
        exit(1)

    try:
        with open(STRUCTURE_FILE, 'r', encoding='utf-8') as file:
            db_schema = file.read().strip()
    except FileNotFoundError:
        print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª —Å—Ö–µ–º—ã '{STRUCTURE_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        exit(1)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å—Ö–µ–º—ã '{STRUCTURE_FILE}': {e}")
        exit(1)

    try:
        with open(DIVISIONS_FILE, 'r', encoding='utf-8') as file:
            divisions_data = file.read().strip()
    except FileNotFoundError:
        print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª –¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤ '{DIVISIONS_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        exit(1)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤ '{DIVISIONS_FILE}': {e}")
        exit(1)

    return gigachat_credentials, db_schema, divisions_data

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω —Ä–∞–∑
GIGACHAT_CREDENTIALS, otgruzki_structure, divisions = _load_config_and_data()

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM ---
try:
    llm = GigaChat(
        credentials=GIGACHAT_CREDENTIALS,
        model="GigaChat-2-Max", # –ò—Å–ø–æ–ª—å–∑—É–µ–º Pro –¥–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á SQL/–∞–Ω–∞–ª–∏–∑–∞
        verify_ssl_certs=False, # –û—Å—Ç–∞–≤—å—Ç–µ False, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
        temperature=0.01,       # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        timeout=600             # –£–≤–µ–ª–∏—á–∏–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    )
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
    # llm.invoke("–ü—Ä–∏–≤–µ—Ç!")
    print("GigaChat LLM –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ.")
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GIGACHAT_CREDENTIALS –≤–µ—Ä–Ω—ã –∏ –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞.")
    exit(1)


# --- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ ---

def load_base_history(filename: str = BASE_HISTORY_FILE) -> list[BaseMessage]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑ JSON-—Ñ–∞–π–ª–∞ (–æ–¥–∏–Ω JSON –æ–±—ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–æ–∫—É).
    """
    messages = []
    if not os.path.exists(filename):
        print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª –±–∞–∑–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ '{filename}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π.")
        # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        try:
            with open(filename, 'w', encoding='utf-8') as f:
                pass # –ü—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª
        except Exception as e:
             print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –±–∞–∑–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ '{filename}': {e}")
        return messages # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫

    try:
        with open(filename, 'r', encoding='utf-8') as f:
            for i, line in enumerate(f):
                line = line.strip()
                if not line:
                    continue
                try:
                    record = json.loads(line)
                    msg_type = record.get("type")
                    content = record.get("content", "")

                    if msg_type == "human_answer" or msg_type == "human":
                        messages.append(HumanMessage(content=content))
                    elif msg_type == "agent_answer" or msg_type == "ai":
                        messages.append(AIMessage(content=content))
                    elif msg_type == "system":
                         messages.append(SystemMessage(content=content))
                    else:
                        print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è '{msg_type}' –≤ —Å—Ç—Ä–æ–∫–µ {i+1} —Ñ–∞–π–ª–∞ '{filename}'.")

                except json.JSONDecodeError as e:
                    print(f"–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –≤ —Å—Ç—Ä–æ–∫–µ {i+1} —Ñ–∞–π–ª–∞ '{filename}': {e}")
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫–∏ {i+1} —Ñ–∞–π–ª–∞ '{filename}': {e}")

    except Exception as e:
        print(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–∑–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ '{filename}': {e}")

    return messages

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
print(f"–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ {BASE_HISTORY_FILE}...")
base_history_messages = load_base_history(BASE_HISTORY_FILE)
print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(base_history_messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –±–∞–∑–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏.")

# --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥—Ä–∞—Ñ–∞ ---

class MessagesState(TypedDict):
    messages: Annotated[List[BaseMessage], add_messages]
    # –î–æ–±–∞–≤–∏–º –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞—Ç—å –µ–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    final_instruction: str | None

# --- –£–∑–ª—ã –≥—Ä–∞—Ñ–∞ ---

def validate_instruction(state: MessagesState) -> Dict[str, Union[List[BaseMessage], str, None]]:
    """
    –£–∑–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏–π.
    """
    current_messages = state['messages']
    last_user_message = current_messages[-1].content.strip()

    print(f"\n--- –£–∑–µ–ª: validate_instruction ---")
    print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {last_user_message}")

    sys_msg_content = (
        f"–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î:\n{otgruzki_structure}\n\n"
        f"–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤:\n{divisions}\n"
        f"–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: {datetime.date.today().strftime('%Y%m%d')}\n\n"
        "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ø–æ–º–æ–≥–∞—é—â–∏–π —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–≥—Ä—É–∑–æ–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∏ —É—Ç–æ—á–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
        "–ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n"
        "1. –ü—Ä–æ–≤–µ—Ä—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–Ω—ã–º –ø–æ–ª—è–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø–æ–º–∏–Ω–∞–µ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è, —É–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ.\n"
        "2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ø–°–ù–û, –∫–∞–∫–∏–µ –ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–û–õ–Ø (—Å—Ç–æ–ª–±—Ü—ã) –Ω—É–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏. –ó–∞–ø—Ä–æ—Å '–ø–æ–∫–∞–∂–∏ –æ—Ç–≥—Ä—É–∑–∫–∏' –Ω–µ–≤–∞–ª–∏–¥–µ–Ω - –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å, –ß–¢–û –∏–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ø–æ–∫–∞–∂–∏ —á–∏—Å—Ç—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'). –ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å –≤—Å–µ –ø–æ–ª—è (`SELECT *`).\n"
        "3. –ü—Ä–æ–≤–µ—Ä—å, –ø–æ–Ω—è—Ç–Ω—ã –ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã (–¥–∞—Ç—ã, –¥–∏–≤–∏–∑–∏–æ–Ω—ã, –∫–ª–∏–µ–Ω—Ç—ã –∏ —Ç.–¥.). –ï—Å–ª–∏ –ø–µ—Ä–∏–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω, —É—Ç–æ—á–Ω–∏ (–Ω–µ–ª—å–∑—è –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è).\n"
        "4. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ—è—Å–Ω–æ –∏–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º, –∑–∞–¥–∞–π –ö–û–†–û–¢–ö–ò–ô —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å. –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–£—Ç–æ—á–Ω–∏—Ç–µ, –∫–∞–∫–∏–µ –ø–æ–ª—è –≤—ã–≤–µ—Å—Ç–∏: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–ª–∏ –æ–±–∞?').\n"
        "5. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–û–õ–ù–û–°–¢–¨–Æ —è—Å–µ–Ω, —Ç–æ—á–µ–Ω –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º, –æ—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "ok\n<–ó–¥–µ—Å—å —á–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL>\n"
        "–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ 'ok':\nok\n–ü–æ–∫–∞–∂–∏ —Å—É–º–º—É —á–∏—Å—Ç–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (NETWR) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç—É—Ä (FKIMG) –¥–ª—è –¥–∏–≤–∏–∑–∏–æ–Ω–∞ '100' –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å ({datetime.date.today() - datetime.timedelta(days=1):%Y%m%d}).\n"
        "–í–ê–ñ–ù–û: –ü–æ–ª–µ –¥–∞—Ç—ã –§–ê–ö–¢–£–†–´ (FKDAT) –≤ —Ç–∞–±–ª–∏—Ü–µ –ï–°–¢–¨. –ù–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ –µ–≥–æ –Ω–µ—Ç.\n"
        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ: –ª–∏–±–æ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –ª–∏–±–æ 'ok' —Å –∏—Ç–æ–≥–æ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π."
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è LLM: —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + —Ç–µ–∫—É—â–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    conversation_for_llm = [SystemMessage(content=sys_msg_content)] + current_messages

    while True:
        print("\n–í—ã–∑–æ–≤ LLM –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏...")
        try:
            response = llm.invoke(conversation_for_llm)
            result_text = response.content.strip()
            print(f"–û—Ç–≤–µ—Ç LLM (–≤–∞–ª–∏–¥–∞—Ü–∏—è): {result_text}")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ LLM –≤ validate_instruction: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –≥—Ä–∞—Ñ –º–æ–≥ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
            return {"messages": [AIMessage(content=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏: {e}")]}

        lower_text = result_text.lower()
        if lower_text.startswith("ok"):
            # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∞
            parts = result_text.split('\n', 1)
            final_instruction = parts[1].strip() if len(parts) > 1 else "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω–∞ –ø–æ—Å–ª–µ 'ok'"
            print(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∞: {final_instruction}")

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "ok..." –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ state
            return {
                "messages": [AIMessage(content=result_text)], # –°–æ–æ–±—â–µ–Ω–∏–µ "ok, –≤–æ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."
                "final_instruction": final_instruction
            }
        else:
            # –ú–æ–¥–µ–ª—å –ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π
            print(f"‚ö†Ô∏è –£—Ç–æ—á–Ω–µ–Ω–∏–µ –æ—Ç –º–æ–¥–µ–ª–∏: {result_text}")
            try:
                # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –º–æ–¥–µ–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
                ai_question_message = AIMessage(content=result_text)
                conversation_for_llm.append(ai_question_message)

                clarification = input(f"üîÑ [{datetime.datetime.now().strftime('%H:%M:%S')}] –í–≤–µ–¥–∏—Ç–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ (–∏–ª–∏ 'stop' –¥–ª—è –≤—ã—Ö–æ–¥–∞):\n{result_text}\n> ")
                clarification = clarification.strip()

                if clarification.lower() == 'stop' or not clarification:
                    print("–ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
                    return {
                        "messages": [ai_question_message, HumanMessage(content=clarification), AIMessage(content="–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")],
                        "final_instruction": None # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                        }

                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—ã–∑–æ–≤–∞ LLM
                user_clarification_message = HumanMessage(content=clarification)
                conversation_for_llm.append(user_clarification_message)
                # –≠—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (ai_question_message, user_clarification_message)
                # –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∏–∑ —É–∑–ª–∞, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –æ–±—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏,
                # –Ω–æ –º—ã —Å–¥–µ–ª–∞–µ–º —ç—Ç–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è (–ª–∏–±–æ —á–µ—Ä–µ–∑ 'ok', –ª–∏–±–æ —á–µ—Ä–µ–∑ 'stop').
                # –ü–æ–∫–∞ –æ–Ω–∏ –∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π `conversation_for_llm`.

            except EOFError: # –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ
                 print("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ (EOF), –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
                 return {
                     "messages": [AIMessage(content="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–≤–æ–¥–∞, –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞.")],
                     "final_instruction": None
                     }
            except Exception as e:
                 print(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–≤–æ–¥–∞: {e}")
                 return {
                     "messages": [AIMessage(content=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞: {e}")],
                     "final_instruction": None
                     }


def generate_sql_query(state: MessagesState) -> Dict[str, Union[List[BaseMessage], str, None]]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–∑ state.
    """
    print(f"\n--- –£–∑–µ–ª: generate_sql_query ---")
    validated_instruction = state.get('final_instruction')

    if not validated_instruction:
         print("–û—à–∏–±–∫–∞: –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏.")
         # –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è None (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ 'stop' –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏), –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º SQL
         # –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–ª—å—à–µ –∏–ª–∏ –º–æ–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –≥—Ä–∞—Ñ –∑–¥–µ—Å—å.
         # –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–µ–º –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, comment_sql_query –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç.
         return {"messages": [AIMessage(content="-- SQL generation skipped (no instruction) --")]}

    print(f"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL: {validated_instruction}")

    sys_msg_content = (
        "–¢—ã ‚Äì —ç–∫—Å–ø–µ—Ä—Ç –ø–æ SQL (HANA) –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –¢–û–ß–ù–´–ô –∏ –û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô SQL-–∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SAP HANA.\n"
        f"–ó–ê–ü–†–û–°–´ –ò–î–£–¢ –¢–û–õ–¨–ö–û –ö –¢–ê–ë–õ–ò–¶–ï: SAPABAP1.ZZSDM_117_CUS\n"
        f"–ï—ë —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:\n{otgruzki_structure}\n\n"
        f"–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–¥—ã –≤ –∑–∞–ø—Ä–æ—Å–µ):\n{divisions}\n\n"
        f"–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: {datetime.date.today().strftime('%Y%m%d')}\n\n"
        "–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –ì–ï–ù–ï–†–ê–¶–ò–ò SQL:\n"
        "1.  –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø–æ–ª—è –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã `SAPABAP1.ZZSDM_117_CUS`.\n"
        "2.  –î–ª—è –ø–æ–ª–µ–π-—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ, –¥–∞—Ç—ã, –∫–æ–¥—ã) –∏—Å–ø–æ–ª—å–∑—É–π `GROUP BY`.\n"
        "3.  –î–ª—è –ø–æ–ª–µ–π-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (—á–∏—Å–ª–æ–≤—ã–µ: NETWR, FKIMG, ZZACOST, ZZMARG) –∏—Å–ø–æ–ª—å–∑—É–π –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`SUM`, `COUNT`, `AVG`). `COUNT(DISTINCT FKNUM)` –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç—É—Ä, `COUNT(DISTINCT KUNNR)` –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.\n"
        "4.  –î–∞—Ç—ã –≤ `WHERE` —É–∫–∞–∑—ã–≤–∞–π –Ø–í–ù–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYYMMDD' (–Ω–∞–ø—Ä–∏–º–µ—Ä, `WHERE FKDAT = '20231027'`).\n"
        "5.  –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ (`FKDAT`). –ù–µ–ª—å–∑—è –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è. –ï—Å–ª–∏ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–µ—Ä–∏–æ–¥ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–≤ –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ'), —Ä–∞—Å—Å—á–∏—Ç–∞–π –¥–∞—Ç—ã —Å–∞–º.\n"
        "6.  –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∏–≤–∏–∑–∏–æ–Ω—É –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª—è `ZZDVAN`, `ZZDVAN2`, ..., `ZZDVAN5`. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–¥ –¥–∏–≤–∏–∑–∏–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '100'), –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ `WHERE` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `WHERE ZZDVAN = '100'`). –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–£—Ä–∞–ª'), –Ω–∞–π–¥–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ.\n"
        "7.  –ü—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∏–ª–∏ –Ω–∞—Ü–µ–Ω–∫–∏) –ò–°–ü–û–õ–¨–ó–£–ô `CASE WHEN <–∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å> != 0 THEN <—á–∏—Å–ª–∏—Ç–µ–ª—å> / <–∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å> ELSE 0 END` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å.\n"
        "8.  –§–æ—Ä–º—É–ª–∞ –Ω–∞—Ü–µ–Ω–∫–∏: `CASE WHEN ZZACOST != 0 THEN (ZZMARG / ZZACOST) * 100 ELSE 0 END`.\n"
        "9.  –ó–ê–ü–†–ï–©–ï–ù–û: `SELECT *`, `WITH` (CTE), `NULLIF`, –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã (—Å—Ç–∞—Ä–∞–π—Å—è –∏–∑–±–µ–≥–∞—Ç—å, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ).\n"
        "10. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Å–µ–≤–¥–æ–Ω–∏–º—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `T1`) –∏ –¥–ª—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π (`AS alias_name`).\n"
        "11. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π, —á—Ç–æ –Ω—É–∂–Ω–∞ —Å—É–º–º–∞ (`SUM`) –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.\n"
        "12. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–≤–æ–¥–∞, –¥–æ–±–∞–≤—å `LIMIT 20`.\n\n"
        "–ó–ê–î–ê–ß–ê: –ù–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞–ø–∏—à–∏ –û–î–ò–ù SQL-–∑–∞–ø—Ä–æ—Å.\n"
        "–û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –°–û–î–ï–†–ñ–ê–¢–¨ –¢–û–õ–¨–ö–û SQL-–ö–û–î, –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –ø–æ—è—Å–Ω–µ–Ω–∏–π –î–û –∏–ª–∏ –ü–û–°–õ–ï."
    )

    conversation = [
        SystemMessage(content=sys_msg_content),
        HumanMessage(content=f"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {validated_instruction}")
    ]

    print("–í—ã–∑–æ–≤ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL...")
    try:
        response = llm.invoke(conversation)
        sql_query = response.content.strip()
        # –ü—Ä–æ—Å—Ç–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö ```sql ``` –±–ª–æ–∫–æ–≤
        if sql_query.startswith("```sql"):
            sql_query = sql_query[6:]
        if sql_query.endswith("```"):
            sql_query = sql_query[:-3]
        sql_query = sql_query.strip()

        print(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω SQL: \n{sql_query}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º SQL –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
        return {"messages": [AIMessage(content=sql_query)]}
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ LLM –≤ generate_sql_query: {e}")
        return {"messages": [AIMessage(content=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL: {e}")]}


def comment_sql_query(state: MessagesState) -> Dict[str, Union[List[BaseMessage], str, None]]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ SQL-–∑–∞–ø—Ä–æ—Å—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    print(f"\n--- –£–∑–µ–ª: comment_sql_query ---")
    current_messages = state['messages']
    final_instruction = state.get('final_instruction') # –ë–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é

    # –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ/–ø—Ä–æ–ø—É—Å–∫–µ
    last_message = current_messages[-1]
    sql_query = ""
    if isinstance(last_message, AIMessage) and \
       "sql generation skipped" not in last_message.content.lower() and \
       "–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ sql" not in last_message.content.lower():
        sql_query = last_message.content.strip()
    else:
        print("SQL-–∑–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—à–∏–±–∫—É –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫) –∫–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        return {"messages": [last_message]}

    if not final_instruction:
        print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ò—Å—Ö–æ–¥–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º.")
        # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ fallback
        for msg in reversed(current_messages[:-1]):
            if isinstance(msg, HumanMessage):
                final_instruction = msg.content # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                break
        if not final_instruction:
            final_instruction = "[–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞]"


    print(f"SQL –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: \n{sql_query}")
    print(f"–ù–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: {final_instruction}")
    
    sys_msg_content =(
        "–¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä—è—Å–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –ø–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞.\n"
        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –í–ò–î–ò–¢ —Å–∞–º SQL-–∑–∞–ø—Ä–æ—Å.\n"
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞ –æ—Å–Ω–æ–≤–µ –ò–ù–°–¢–†–£–ö–¶–ò–ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ SQL-–ó–ê–ü–†–û–°–ê –Ω–∞–ø–∏—Å–∞—Ç—å –ü–û–ù–Ø–¢–ù–´–ô –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.\n\n"
        "–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:\n"
        "1. –ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã, –æ–ø–∏—Å—ã–≤–∞—é—â–µ–π, –ß–¢–û –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–•–æ—Ä–æ—à–æ, —è –ø–æ–∫–∞–∂—É...', '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∫–∞–∂–µ—Ç...', '–í–æ—Ç –¥–∞–Ω–Ω—ã–µ –æ...').\n"
        "2. –ü–µ—Ä–µ—á–∏—Å–ª–∏ –ü–û–õ–Ø, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ `SELECT` —á–∞—Å—Ç–∏ SQL-–∑–∞–ø—Ä–æ—Å–∞. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –ø—Å–µ–≤–¥–æ–Ω–∏–º—ã –∏–∑ SQL (–Ω–∞–ø—Ä–∏–º–µ—Ä, '...–æ–±—â—É—é —á–∏—Å—Ç—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (total_net_value) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç—É—Ä (invoice_count)...'). –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π `<placeholder>`.\n"
        "3. –£–∫–∞–∂–∏ –ö–õ–Æ–ß–ï–í–´–ï –§–ò–õ–¨–¢–†–´ –∏–∑ `WHERE` —á–∞—Å—Ç–∏ SQL: –ø–µ—Ä–∏–æ–¥ –¥–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, '...–∑–∞ –ø–µ—Ä–∏–æ–¥ —Å 2023-10-01 –ø–æ 2023-10-31'), –¥–∏–≤–∏–∑–∏–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, '...–¥–ª—è –¥–∏–≤–∏–∑–∏–æ–Ω–∞ '–£—Ä–∞–ª' (–∫–æ–¥ 200)'), –∏ –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.\n"
        "4. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –§–û–†–ú–£–õ–´ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏), –∫—Ä–∞—Ç–∫–æ —É–ø–æ–º—è–Ω–∏ —ç—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '...—Ç–∞–∫–∂–µ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –Ω–∞—Ü–µ–Ω–∫–∞').\n"
        "5. –ï—Å–ª–∏ –µ—Å—Ç—å `GROUP BY`, —É–∫–∞–∂–∏, –ø–æ –∫–∞–∫–∏–º –ø–æ–ª—è–º —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '...—Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º').\n"
        "6. –ï—Å–ª–∏ –µ—Å—Ç—å `LIMIT`, —É–ø–æ–º—è–Ω–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '...–±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 20 –∑–∞–ø–∏—Å–µ–π').\n"
        "7. –ì–æ–≤–æ—Ä–∏ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –∏–ª–∏ –±—É–¥—É—â–µ–º –≤—Ä–µ–º–µ–Ω–∏ ('–ó–∞–ø—Ä–æ—Å –ø–æ–∫–∞–∂–µ—Ç...', '–í—ã —É–≤–∏–¥–∏—Ç–µ...').\n"
        "8. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫, –ø–æ–Ω—è—Ç–µ–Ω –∏ –¥—Ä—É–∂–µ–ª—é–±–µ–Ω. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∂–∞—Ä–≥–æ–Ω, –∫—Ä–æ–º–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π –∏–∑ SELECT.\n"
        "9. –ù–ï –≤–∫–ª—é—á–∞–π —Å–∞–º SQL-–∑–∞–ø—Ä–æ—Å –≤ –æ—Ç–≤–µ—Ç.\n\n"
        "–ó–ê–î–ê–ß–ê: –°—Ñ–æ—Ä–º–∏—Ä—É–π –∏—Ç–æ–≥–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
    )

    human_msg_content = (
        f"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ç–æ—Ä–æ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è SQL):\n{final_instruction}\n\n"
        f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL:\n{sql_query}\n\n"
        "–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º."
    )

    conversation = [
        SystemMessage(content=sys_msg_content),
        HumanMessage(content=human_msg_content)
    ]

    print("–í—ã–∑–æ–≤ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è...")
    try:
        response = llm.invoke(conversation)
        comment = response.content.strip()
        print(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}")

        # –ú—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –±—ã–ª –∏–º–µ–Ω–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        # SQL-–∑–∞–ø—Ä–æ—Å —É–∂–µ –µ—Å—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π state['messages'][-1]
        # –ü–æ—ç—Ç–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        return {"messages": [AIMessage(content=comment)]}
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ LLM –≤ comment_sql_query: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–º–µ—Å—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        return {"messages": [AIMessage(content=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: {e}")]}


# --- –°–±–æ—Ä–∫–∞ –≥—Ä–∞—Ñ–∞ ---
workflow = StateGraph(MessagesState)

# –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã
workflow.add_node("validate_instruction", validate_instruction)
workflow.add_node("generate_sql_query", generate_sql_query)
workflow.add_node("comment_sql_query", comment_sql_query)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞
workflow.set_entry_point("validate_instruction")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã
workflow.add_edge("validate_instruction", "generate_sql_query")
workflow.add_edge("generate_sql_query", "comment_sql_query")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É
workflow.add_edge("comment_sql_query", END)

# --- –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å —á–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä–æ–º ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º SqliteSaver –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
try:
    memory = SqliteSaver.from_conn_string(CHECKPOINT_DB)
    print(f"–ß–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º '{CHECKPOINT_DB}'.")
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SqliteSaver –¥–ª—è '{CHECKPOINT_DB}': {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.")
    exit(1)

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≥—Ä–∞—Ñ, –ø–æ–¥–∫–ª—é—á–∞—è —á–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä
final_agent = workflow.compile(checkpointer=memory)
print("–ì—Ä–∞—Ñ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω.")

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–ª–æ–≥–∞ ---

def run_conversation(user_id: str, initial_message: str):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ user_id."""
    thread_id = f"user_{user_id}" # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    config = {"configurable": {"thread_id": thread_id}}

    print(f"\n===== –î–∏–∞–ª–æ–≥ –¥–ª—è {thread_id} =====")
    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {initial_message}")

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏—Å—Ç–æ—Ä–∏—é) –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    current_state = None
    try:
        current_state = final_agent.get_state(config)
    except Exception as e:
        print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è {thread_id}. –í–æ–∑–º–æ–∂–Ω–æ, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û—à–∏–±–∫–∞: {e}")

    is_new_thread = not current_state or not current_state.values.get('messages')

    # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    input_message = HumanMessage(content=initial_message)
    # –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞,
    # —á–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä —Å–∞–º –ø–æ–¥–≥—Ä—É–∑–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –∏ –¥–æ–±–∞–≤–∏—Ç –±–∞–∑–æ–≤—É—é + –Ω–æ–≤—É—é
    input_data = {"messages": []}
    final_instruction_for_input = None # –ù–µ –ø–µ—Ä–µ–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∞ –≤—Ö–æ–¥

    if is_new_thread:
        print("–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥, –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é.")
        if base_history_messages:
            # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –ü–ï–†–ï–î –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            input_data["messages"].extend(base_history_messages)
        else:
            print("–ë–∞–∑–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")

    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    input_data["messages"].append(input_message)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –≥—Ä–∞—Ñ
    print("\n–ó–∞–ø—É—Å–∫ –≥—Ä–∞—Ñ–∞...")
    final_result_message = None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º invoke –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        final_state = final_agent.invoke(input_data, config=config)

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if final_state and final_state.get('messages'):
            final_result_message = final_state['messages'][-1]
        else:
             print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.")

    except Exception as e:
        print(f"\n!!! –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞ –¥–ª—è {thread_id}: {e}")
        import traceback
        traceback.print_exc() # –ü–µ—á–∞—Ç–∞–µ–º traceback –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

    print("\n--- –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç ---")
    if final_result_message and isinstance(final_result_message, AIMessage):
         print(f"–ê–≥–µ–Ω—Ç: {final_result_message.content}")
    elif final_result_message:
         print(f"–ê–≥–µ–Ω—Ç (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞: {type(final_result_message)}): {final_result_message}")
    else:
        print(f"–ê–≥–µ–Ω—Ç: [–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞]")

    print(f"===== –ö–æ–Ω–µ—Ü –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è {thread_id} =====")
    return final_state # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

# --- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ---
if __name__ == "__main__":

    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    os.makedirs("gpt_db/data/confs", exist_ok=True)
    # –°–æ–∑–¥–∞–¥–∏–º –ø—É—Å—Ç—ã–µ —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    for filepath in [CONFIG_FILE, STRUCTURE_FILE, DIVISIONS_FILE, BASE_HISTORY_FILE]:
        if not os.path.exists(filepath):
            print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª '{filepath}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª.")
            try:
                # –î–ª—è –∫–æ–Ω—Ñ–∏–≥–∞ —Å–æ–∑–¥–∞–¥–∏–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                if filepath == CONFIG_FILE:
                     with open(filepath, 'w', encoding='utf-8') as f:
                         yaml.dump({"GIGACHAT_CREDENTIALS": "YOUR_GIGACHAT_API_KEY_HERE"}, f)
                     print(f"!!! –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ '{CONFIG_FILE}' –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π GIGACHAT_CREDENTIALS.")
                else:
                    with open(filepath, 'w', encoding='utf-8') as f:
                        pass # –ü—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
            except Exception as e:
                print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª '{filepath}': {e}")
                # –ù–µ –≤—ã—Ö–æ–¥–∏–º, —Ç.–∫. –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ä–∞–Ω–µ–µ, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º

    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–∞–π–ª—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å
    GIGACHAT_CREDENTIALS, otgruzki_structure, divisions = _load_config_and_data()
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é
    base_history_messages = load_base_history(BASE_HISTORY_FILE)


    # –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤
    user_querys = [
        "–ü–æ–∫–∞–∂–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è", # –î–æ–ª–∂–µ–Ω —Å–ø—Ä–æ—Å–∏—Ç—å, –ß–¢–û –ø–æ–∫–∞–∑–∞—Ç—å
        "–ü–æ–∫–∞–∂–∏ —á–∏—Å—Ç—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç—É—Ä –∑–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ –≤—Å–µ–º –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º", # –ë–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
        "–°–∫–æ–ª—å–∫–æ –≤ –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ –æ—Ç–≥—Ä—É–∑–∏–ª–∏ –Ω–∞ –£—Ä–∞–ª–µ", # –î–æ–ª–∂–µ–Ω —Å–ø—Ä–æ—Å–∏—Ç—å –ß–¢–û (–∫–ª–∏–µ–Ω—Ç–æ–≤, —Å—Ç–æ–∏–º–æ—Å—Ç—å, –∫–æ–ª-–≤–æ?)
        "–°–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ—Ç–≥—Ä—É–∑–∏–ª–æ—Å—å –Ω–∞ –¥–∞–ª—å–Ω–µ–º –≤–æ—Å—Ç–æ–∫–µ –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É", # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        "–ö—Ç–æ –∏–∑ –Ω–∏—Ö –≥—Ä—É–∑–∏–ª—Å—è —á–∞—â–µ?", # –ó–∞–ø—Ä–æ—Å, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ (—Å–ª–æ–∂–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ–∑ —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)
        "–ü–æ–∫–∞–∂–∏ —Ç–æ–ø 5 –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ —Å—É–º–º–µ –º–∞—Ä–∂–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª –≤ –¥–∏–≤–∏–∑–∏–æ–Ω–µ 100" # –°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    ]

    # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
    user_id_for_test = "test_user_001"
    print("\n" + "="*30 + f"\n–ù–∞—á–∞–ª–æ —Å–µ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è {user_id_for_test}\n" + "="*30)

    for i, query in enumerate(user_querys):
        print(f"\n--- –ó–∞–ø—Ä–æ—Å {i+1} ---")
        run_conversation(user_id=user_id_for_test, initial_message=query)
        print("-" * 20) # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

    print("\n" + "="*30 + f"\n–°–µ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è {user_id_for_test} –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n" + "="*30)

    # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –∏—Å—Ç–æ—Ä–∏–∏
    # print("\n" + "="*30 + f"\n–ù–∞—á–∞–ª–æ —Å–µ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è user_002\n" + "="*30)
    # run_conversation(user_id="user_002", initial_message="–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã?")
    # print("\n" + "="*30 + f"\n–°–µ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è user_002 –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n" + "="*30)